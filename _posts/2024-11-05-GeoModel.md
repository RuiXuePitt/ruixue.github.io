---
title: GeoModel Toolkit for Detector Simulation
math: true
permalink: /GeoModel/
---

## Background
An ultimate goal of particle physics studies is to build a complete theory of the universe governed by elementary particles. With generations of physicists' efforts, the Standard Model (SM) was established, describing how particles are generated, interact, and annihiliate. Within its energy scale, the Standard Model has achieved remarkable triumphs, such as the prediction of anomalous magnetic moment with high precision in $$10^{-12}$$ order, foreseeing of the existence of W/Z bosons, gluons, Higgs, and the explanations of the Higgs mechanism. However, the Standard Model is not a complete theory. Several key phenomena remain unexplained, including the microscopic mechanism of gravity, the nature of dark matter and dark energy, and the origin of neutrino masses. To solve these problems, the theory has to be extended and there are a lot more complicated new theory proposed.

In experiments, researchers test the Standard Model by comparing measured data with theoretical predictions through *hypothesis tesing*. Besides, new theories include anomalous parameters (zero in the SM), which can be constrained using maximum-likelihood fitting techniques. However, the practicle challenge is that capturing particles with a detector (such as ATLAS) is not as simple as having an "all-knowing machine" that declares "oh there is a quark" or "here is a lepton". Instead, the particles hadronize, radiate, ionize in the detectors, and those elecrtonic signals are recorded. From the raw measurements, physicists reconstruct the properties of the underlying particles, such as momentum, charge, and energy. Identifying whether the signal came from a quark, lepton, photon, or hadron then relies on sophisticated reconstruction algorithms and statistical analysis, rather than direct observation. There are groups of researchers developing those advanced algorithms.

![Simu Flow](/assets/img/PostImages/SimuFlow.png){: w="400" h="400" }
_Simulation Work Flow_

Accordingly, rather than relying solely on pure theoretical predictions, full simulation must also incorporate detector effects—such as whether particles can be detected and how they interact with detector materials—since the measured real signals are already convolved with these effects. To numerically simulate particle-detector interactions, high-precision computer models of the detector device is necessary.

## GeoModel Toolkit
[**GeoModel**](https://geomodel.web.cern.ch/home/) is a *computer-aided design* toolkit. It provides a set of geometry primitives-such as box, cylinder, cone, polycone, polyhedron, etc.-which can be combined using Boolean operations including union, intersection, and subtraction. Users can combine these primitives to construct complex detector models for simulation purposes. 

In GeoModel, the detector geometry is represented as a hierarchical tree structure. The root node corresponds to the detector’s top-level volume, and each child node refines the description by defining nested sub-volumes, with the leaves representing the most granular components. This hierarchical design makes traversal and manipulation of the geometry efficient. For example, within the Pixel Detector, a module node may branch into sub-nodes describing sensors, support structures, and readout electronics.

The constructed detector geometry can be stored in *SQLite* database files. For detector simulation, these database files serve as inputs, containing both geometry and material information. They are then passed to the ATLAS simulation framework Athena, which interfaces with Geant4—a toolkit specialized in Monte Carlo simulations of particle–material interactions—to perform the detector simulation.

```
Tree Structure of the Detector Model
    
    Detector
    |--- Pixel Detector
    |    |--- Barrel
    |    |--- End Caps
    |    |--- Cooling System
    |    |--- Support
    |
    |--- Muon Detector
    |    |--- ...
    |
    |--- Liquid Argon System
    |    |--- ...
    |
    |--- ...
```

Another characteristic kernel provided by the GeoModel toolkit is the `GeoModelExplorer`(`gmex`). `gmex` is a graphical user interface which can read in the database file and visualize the detector model. It supports multiple viewing windows, cutaway views, and interactive control over the expansion contraction of the detector model. `gmex` relies on the `Coin` libaries, the `Qt5` class library for GUI, and the `SoQt` library which enables `Qt5` to display `Coin` graphics. `Coin` uses `OpenGL` for rendering.

![ATLAS model](/assets/img/PostImages/ATLASmodel.gif){: w="600" h="600" }
_ATLAS detector model in GeoModel GUI_

## GeoVSurface: Virtual Surface Classes
I was fortunate enough to get involved in the development of GeoModel toolkit, and the works I have done are the design and implementation of the `GeoVSurface` classes. `GeoVSurface` is a newly introduced light-weight class in the recent upgrade of GeoModel. The class is designed for track reconstruction and fast simulation, where people can introduce those "virtual surfaces" to mark the particle-hits within the actual 3D-shape components, and reconstruct particle paths using a series of virtual surfaces by interpolation. Since they are just helper classes and we do not expect software performance degradation due to their existence, the virtual surfaces are supposed to be light-weighted, meaning they should only contain the 2D-shape information. Besides, the GeoVSurface classes must accommodate with all the existing geometry-tree operations, and they are expected to be visualizable as well.

![Tracking](https://acts.readthedocs.io/en/latest/_images/tracking.svg){: w="300" h="300" }
_Illustration of Particle Tracks Reconstruction_

### Class Inheritance
The `GeoVSurface` class is an abstract class, and it has the same inheritance relation as the GeoVFullPhysVol-the real 3D geometry primitive class that holds material information. The `GeoVSurfaceShape` class is an abstract class of 2D-shape information. It is the input parameter of, and can be encapsulated by `GeoVSurface` and then integrated to the geometry tree. Under this abstract class, there are four concrete shape classes, including `GeoRectSurface` (rectangle), `GeoTrapezoidSurface` (trapezoid), `GeoAnnulusSurace` (annulus or irregular sector), `GeoDiamondSurface` (diamond). More shape classes will be introduced under the demand of future ATLAS development works. We designed this inheritance structure to accommodate the virtual classes well with geometry tree operations.

![Class Inheritance](/assets/img/PostImages/class_ref.png){: w="400" h="400" }
_Virtual Surface Class Inheritance Relation_

### Shape Visualization
4 surface shape classes are chosen to cover a range of potential detector components, making the system flexible and adaptable for future uses. The rectangle surface is used for path-reconstruction in the inner silicon strip system. The trapezoid surface is used in muon-system encaps. The diamond surface is useful for the new inner tracking system (ITK) design in the muon systems. The annulus surface is useful for the new ITK design as well, and this tricky shape is potentially used for next generation inner sillicon tracking system to improve the hit-position resolution. Those virtual surface primitives are defined by several parameters, illustrated as followings.

![Shape Design](/assets/img/PostImages/shape_design.png){: w="600" h="400" }
_Shape Design_

The vitual surface shapes can all be visualized by `gmex`. Notice that the shapes can tell whether a point is on the surface or not, which is useful in recording particle hits, and a significant functionality for particle path reconstruction purposes. In the demo, if the testing point is outside of the surface, then the tester will place a small box at that position, while if the point is inside of the surface, a larger box will be placed. The demo shows the shapes are working as expected.

![Virtual Surface Shapes](/assets/img/PostImages/shape_visual.png){: w="600" h="400" }
_Virtual Surface Visualization_

### Alignment Manipulation
An over-simplified silicon system plugin was developed to show how the virtual surfaces work together with the physical volumes. In this demo, the physical silicon volume is shown in gray, while the virtual surface components are colored red and green to distinguish the front and back sides. The key feature here is the alignment transformation. Developers can apply small changes on positioning after assembling the geometry tree. This functionality is useful because there can be small vibrations in the detector components in practice, and updating the real-time positional information is necessary for accurate simulations. As the figure shows, the virtual surface moves together with the physical volume, and this can help update tracking systems.

![Virtual Surface Plugin Demo](/assets/img/PostImages/alignment.png){: w="600" h="400" }
_Virtual Surface Plugin Demo_

### Database Updates

As mentioned at the begining of this post, the detector model should be stored as *SQLite* files, serving as the input of the *Athena* simulation workflow. The virtual surfaces also need to accomodate with this functionality, leading to the updates of *GeoModelIO*, a kernel in charge of database management.

Memory optimization techniques are also applied --- the virtual surface shapes in the same size can be shared in the database. In the silicon system demo, the trapezoid shapes at the endcap systems are the same, and the rectangular shapes at the silicon strip systems are also the same --- the only difference among those components is positioning. Hence the system is designed to store the positional information for each node, but only store the foreign key pointing to the shape. The class sharing method saves the memory, and makes large scale simulations more efficient, especially for real ATLAS detectors, which is made up of thousands of geometry primitives.

![Database Management](/assets/img/PostImages/db_share.png){: w="400" h="400" }
_Database Management_

### User Interaction

To be compatible with virtual surface classes, we updated all the classes related to `gmex` user interactions. The following figure shows that the virtual surfaces can be selected, hidden, and output detailed information successfully.

![Virtual Surface Reponses to User Interactions](/assets/img/PostImages/gui.png){: w="700" h="400" }
_Virtual Surface Reponses to User Interactions_

## Summary
**GeoModel** is the computer-aided design toolkit, providing geometry primitives and Boolean operations to build complex detector models in a hierarchical tree structure. These models can be stored in SQLite databases and used in *Athena* framework with *GEANT4* for full detector simulation.

I contributed to **GeoVSurface** by implementing abstract surface classes, implementing the rendering algorithms, updating the `gmex` user interface and the database storage functionalities. The surface classes are essential for particle tracking, and the new features are merged to the main branch of the GeoModel repository. In the future, we encourage the ATLAS simulation and reconstruction groups to adapt this new change to practical uses. We are open to the feedback and more surface shapes will be added once there are requests.